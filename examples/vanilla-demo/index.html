<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCORM Wrapper Demo</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .demo-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
    }
    h2 {
      color: #667eea;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #5568d3;
    }
    input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin: 5px;
    }
    .info {
      background: #e3f2fd;
      padding: 15px;
      border-left: 4px solid #2196f3;
      margin: 10px 0;
    }
    .success {
      background: #e8f5e9;
      padding: 15px;
      border-left: 4px solid #4caf50;
      margin: 10px 0;
    }
    .output {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
    }
    #log {
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>SCORM/xAPI Wrapper Demo</h1>
  
  <div class="info">
    <strong>Environment:</strong> <span id="environment">Detecting...</span><br>
    <small id="envDetails" style="color: #666; margin-top: 5px; display: block;"></small>
  </div>

  <div class="demo-section" style="background: #263238; color: #aed581; padding: 15px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 12px;">
    <h3 style="color: #fff; margin-bottom: 10px;">üîç Live Data Inspector</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
      <div>
        <strong style="color: #81d4fa;">SCORM/xAPI Data:</strong>
        <pre id="liveData" style="background: #1e272e; padding: 10px; border-radius: 4px; overflow: auto; max-height: 200px; margin-top: 5px;">No data yet</pre>
      </div>
      <div>
        <strong style="color: #ffab91;">LocalStorage Raw:</strong>
        <pre id="liveStorage" style="background: #1e272e; padding: 10px; border-radius: 4px; overflow: auto; max-height: 200px; margin-top: 5px;">No data yet</pre>
      </div>
    </div>
  </div>

  <div class="demo-section">
    <h2>1. Initialization</h2>
    <p>The wrapper has been automatically initialized.</p>
    <div id="initStatus" class="output">Checking...</div>
  </div>

  <div class="demo-section">
    <h2>2. Save Progress</h2>
    <p>Save custom progress data to the LMS:</p>
    <input type="text" id="dataKey" placeholder="Key" value="userName">
    <input type="text" id="dataValue" placeholder="Value" value="John Doe">
    <button onclick="saveCustomProgress()">Save Progress</button>
    <div id="saveStatus" class="output"></div>
  </div>

  <div class="demo-section">
    <h2>3. Load Progress</h2>
    <p>Retrieve previously saved progress:</p>
    <button onclick="loadProgress()">Load Progress</button>
    <div id="loadStatus" class="output"></div>
  </div>

  <div class="demo-section">
    <h2>4. Set Score</h2>
    <p>Set a score for the course (0-100):</p>
    <input type="number" id="scoreValue" min="0" max="100" value="85">
    <button onclick="setScore()">Set Score</button>
    <div id="scoreStatus" class="output"></div>
  </div>

  <div class="demo-section">
    <h2>5. Mark Complete</h2>
    <p>Mark the course as completed:</p>
    <button onclick="markComplete()">Mark Complete</button>
    <div id="completeStatus" class="output"></div>
  </div>

  <div class="demo-section">
    <h2>Developer Tools</h2>
    <button onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
    <button onclick="inspectStorage()">üîç Inspect Storage</button>
    <button onclick="simulateSCORM()">üì¶ Simulate SCORM (coming soon)</button>
  </div>

  <div class="demo-section">
    <h2>Event Log</h2>
    <div id="log" class="output"></div>
  </div>

  <script type="module">
    import ScormWrapper from './scorm-wrapper.esm.js';

    // Make globally available for onclick handlers
    window.ScormWrapper = ScormWrapper;

    // Log function
    window.log = (message) => {
      const logEl = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logEl.textContent += `[${timestamp}] ${message}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    };

    // Update live data display
    window.updateLiveData = () => {
      const env = ScormWrapper.getEnvironmentType();
      
      // Show SCORM/wrapper data
      ScormWrapper.getProgress().then(data => {
        document.getElementById('liveData').textContent = 
          data ? JSON.stringify(data, null, 2) : 'null (no data saved yet)';
      });
      
      // Show raw localStorage
      const storageData = {};
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('scorm')) {
          try {
            storageData[key] = JSON.parse(localStorage.getItem(key));
          } catch {
            storageData[key] = localStorage.getItem(key);
          }
        }
      }
      document.getElementById('liveStorage').textContent = 
        Object.keys(storageData).length > 0 
          ? JSON.stringify(storageData, null, 2)
          : '(no SCORM data in localStorage)';
    };

    // Initialize
    (async () => {
      try {
        await ScormWrapper.initialize();
        const env = ScormWrapper.getEnvironmentType();
        
        document.getElementById('environment').textContent = env.toUpperCase();
        
        // Show environment details
        let envDetails = '';
        if (env === 'local') {
          envDetails = 'Running in LOCAL mode - using localStorage to simulate LMS. When deployed to a real LMS, this will automatically switch to SCORM 2004 or xAPI.';
        } else if (env === 'scorm2004') {
          envDetails = 'Connected to SCORM 2004 LMS - using cmi.suspend_data for storage';
        } else if (env === 'xapi') {
          envDetails = 'Connected to xAPI LRS - using State API for storage';
        }
        document.getElementById('envDetails').textContent = envDetails;
        
        document.getElementById('initStatus').textContent = 
          `‚úì Initialized successfully\nEnvironment: ${env}\n\nAdapter: ${env === 'local' ? 'LocalStorageAdapter' : env === 'scorm2004' ? 'SCORM2004Adapter' : 'XAPIAdapter'}`;
        
        log(`Initialized with environment: ${env}`);
        log(`This demo uses ${env === 'local' ? 'localStorage' : env} adapter`);

        // Load any existing progress
        const existing = await ScormWrapper.getProgress();
        if (existing) {
          log('Found existing progress: ' + JSON.stringify(existing, null, 2));
        }
        
        // Update live data display
        updateLiveData();
        
        // Auto-refresh live data every 2 seconds
        setInterval(updateLiveData, 2000);
        
      } catch (error) {
        document.getElementById('initStatus').textContent = 
          `‚úó Initialization failed: ${error.message}`;
        log(`ERROR: ${error.message}`);
      }
    })();

    // Save progress
    window.saveCustomProgress = async () => {
      const key = document.getElementById('dataKey').value;
      const value = document.getElementById('dataValue').value;
      
      try {
        // Get existing progress
        const existing = await ScormWrapper.getProgress() || {};
        
        // Add new data
        existing[key] = value;
        existing.timestamp = new Date().toISOString();
        
        // Save
        await ScormWrapper.saveProgress(existing);
        
        document.getElementById('saveStatus').textContent = 
          `‚úì Saved successfully\n${JSON.stringify(existing, null, 2)}`;
        log(`Progress saved: ${key} = ${value}`);
        updateLiveData();
      } catch (error) {
        document.getElementById('saveStatus').textContent = 
          `‚úó Save failed: ${error.message}`;
        log(`ERROR: ${error.message}`);
      }
    };

    // Load progress
    window.loadProgress = async () => {
      try {
        const progress = await ScormWrapper.getProgress();
        
        if (progress) {
          document.getElementById('loadStatus').textContent = 
            `‚úì Loaded successfully\n${JSON.stringify(progress, null, 2)}`;
          log('Progress loaded');
        } else {
          document.getElementById('loadStatus').textContent = 
            'No saved progress found';
          log('No saved progress');
        }
      } catch (error) {
        document.getElementById('loadStatus').textContent = 
          `‚úó Load failed: ${error.message}`;
        log(`ERROR: ${error.message}`);
      }
    };

    // Set score
    window.setScore = async () => {
      const score = parseInt(document.getElementById('scoreValue').value);
      
      try {
        await ScormWrapper.setScore(score);
        document.getElementById('scoreStatus').textContent = 
          `‚úì Score set to ${score}`;
        log(`Score set: ${score}`);
        updateLiveData();
      } catch (error) {
        document.getElementById('scoreStatus').textContent = 
          `‚úó Score failed: ${error.message}`;
        log(`ERROR: ${error.message}`);
      }
    };

    // Clear all data
    window.clearAllData = () => {
      if (confirm('Clear all saved data? This will reset the demo.')) {
        localStorage.clear();
        location.reload();
      }
    };

    // Inspect storage
    window.inspectStorage = () => {
      console.log('=== LocalStorage Contents ===');
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        console.log(key + ':', localStorage.getItem(key));
      }
      log('Storage contents logged to console (F12 > Console)');
    };

    // Simulate SCORM
    window.simulateSCORM = () => {
      alert('SCORM simulation coming soon! For now, deploy to a real LMS or use SCORM Cloud to test SCORM mode.');
    };

    // Mark complete
    window.markComplete = async () => {
      try {
        await ScormWrapper.setComplete();
        document.getElementById('completeStatus').textContent = 
          '‚úì Course marked as complete';
        log('Course completed');
        updateLiveData();
      } catch (error) {
        document.getElementById('completeStatus').textContent = 
          `‚úó Complete failed: ${error.message}`;
        log(`ERROR: ${error.message}`);
      }
    };
  </script>
</body>
</html>

